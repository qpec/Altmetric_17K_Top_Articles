  1 / 55 
 
Rapid whole brain imaging of neural activity in freely 
1 
behaving larval zebrafish (Danio rerio) 
2 
 
3 
Lin Cong1,4, Zeguan Wang2,4, Yuming Chai2,4, Wei Hang1,4, Chunfeng Shang1, Wenbin 
4 
Yang2, Lu Bai1, Jiulin Du1, Kai Wang1,3, Quan Wen2 
5 
 
6 
1. Institute of Neuroscience, State Key Laboratory of Neuroscience, CAS Center for 
7 
Excellence in Brain Science and Intelligence Technology, Chinese Academy of 
8 
Sciences, Shanghai 200031, China. 
9 
 
10 
2. Center for Integrative Imaging, Hefei National Laboratory for Physical Sciences at 
11 
Microscale, CAS Center for Excellence in Brain Science and Intelligence Technology, 
12 
University of Science and Technology of China, Hefei, 230027, China. 
13 
 
14 
3. University of Chinese Academy of Sciences, Beijing 100049, China. 
15 
 
16 
4. These authors contributed equally to this work. 
17 
 
18 
Correspondence should be addressed to K.W. (wangkai@ion.ac.cn) or Q.W. 
19 
(qwen@ustc.edu.cn). 
20 
 
21 
 
22 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  2 / 55 
 
Abstract: 
23 
The internal brain dynamics that link sensation and action are arguably better studied 
24 
during natural animal behaviors. Here we report on a novel volume imaging and 3D 
25 
tracking technique that monitors whole brain neural activity in freely swimming larval 
26 
zebrafish (Danio rerio). We demonstrated the capability of our system through functional 
27 
imaging of neural activity during visually evoked and prey capture behaviors in larval 
28 
zebrafish. 
29 
 
30 
 
31 
Author Contributions 
32 
 
33 
K.W. and Q.W. conceived the project. K.W. conceived the idea of XLFM. L.C., Z.W., 
34 
W.H., L.B. and K.W. designed and built the XLFM. Y.C. Z.W. W.Y. and Q.W. designed 
35 
and built the X-Y tracking and the real-time behavioral analysis system. L.C., Z.W., W.H. 
36 
and K.W. designed and built the autofocus system. All authors worked collaboratively to 
37 
integrate the XLFM and the tracking system together. C.S., J.D. and Q.W. designed 
38 
zebrafish behavioral experiments. Y.C., Z.W., L.C. and W.H. did experiments under the 
39 
supervision of C.S., J.D. K.W. and Q.W.. K.W and Q.W. wrote the paper with inputs 
40 
from all authors. 
41 
 
 
42 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  3 / 55 
 
Main text: 
43 
Introduction: 
44 
A central goal in systems neuroscience is to understand how distributed neural circuitry 
45 
dynamics drive animal behaviors. The emerging field of optical neurophysiology allows 
46 
the monitoring [1, 2] and manipulating [3-5] of the activities of defined populations of 
47 
neurons that express genetically encoded activity indicators [6, 7] and light-activated 
48 
proteins [1, 4, 5, 8]. Larval zebrafish (Danio rerio) are an attractive model system to 
49 
investigate the neural correlates of behaviors owing to their small brain size, optical 
50 
transparency, and rich behavioral repertoire [9, 10]. Whole brain imaging of larval 
51 
zebrafish using light sheet/two-photon microscopy holds considerable potential in 
52 
creating a comprehensive functional map that links neuronal activities and behaviors [11-
53 
13]. 
54 
 
55 
Recording neural activity maps in larval zebrafish has been successfully integrated with 
56 
the virtual reality paradigm: closed-loop fictive behaviors in immobilized fish can be 
57 
monitored and controlled via visual feedback that varies according to the electrical output 
58 
patterns of motor neurons [11, 14]. The behavioral repertoire, however, may be further 
59 
expanded in freely swimming zebrafish whose behavioral states can be directly inferred 
60 
and when sensory feedback loops are mostly intact and active. For example, it is likely 
61 
that vestibular as well as proprioceptive feedbacks are perturbed in immobilized zebrafish 
62 
[14, 15]. The crowning moment during hunting behavior [16-18]  when a fish succeeds 
63 
in catching a paramecium  cannot be easily replicated in a virtual reality setting. 
64 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  4 / 55 
 
Therefore, whole brain imaging in a freely swimming zebrafish may allow optical 
65 
interrogation of brain circuits underlying a range of less explored behaviors. 
66 
 
67 
Although whole brain functional imaging methods are available for head-fixed larval 
68 
zebrafish, imaging a speeding brain imposes many technical challenges. Current studies 
69 
on freely swimming zebrafish are either limited to non-imaging optical systems [19] or 
70 
wide field imaging at low resolution [20]. While light sheet microscopy (LSM) has 
71 
demonstrated entire brain coverage and single neuron resolution in restrained zebrafish 
72 
[12], it lacks the speed to follow rapid fish movement. Moreover, in LSM, the sample is 
73 
illuminated from its side, a configuration that is difficult to be integrated with a tracking 
74 
system. Conventional light field microscopy (LFM) [21, 22] is a promising alternative 
75 
due to its higher imaging speed; however, its spatial resolution is relatively low. 
76 
Specialized LFMs for monitoring neural activity utilizing temporal information were also 
77 
developed recently [23, 24], which rely on spatiotemporal sparsity of fluorescent signals 
78 
and cannot be applied to moving animals. 
79 
 
80 
Here, we describe a fast 3D tracking technique and a novel volume imaging method that 
81 
allow whole brain calcium imaging with high spatial and temporal resolution in freely 
82 
behaving larval zebrafish. Zebrafish larvae possess extraordinary mobility. They can 
83 
move at an instantaneous velocity up to 50 mm/s [25] and acceleration of 1 g (9.83 m/s2). 
84 
To continuously track fish motion, we developed a high-speed closed-loop system in 
85 
which (1) customized machine vision software allowed rapid estimation of fish 
86 
movement in both the x-y and z directions; and, (2) feedback control signals drove a 
87 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  5 / 55 
 
high-speed motorized x-y stage (at 300 Hz) and a piezo Z stage (at 100 Hz) to retain the 
88 
entire fish head within the field of view of a high numerical aperture (25×, NA = 1.05) 
89 
objective.  
90 
 
91 
Larval zebrafish can make sudden and swift movements that easily cause motion blur and 
92 
severely degrade imaging quality. To overcome this obstacle, we developed a new 
93 
eXtended field of view LFM (XLFM). The XLFM can image sparse neural activity over 
94 
the larval zebrafish brain at near single cell resolution and at a volume rate of 77 Hz, with 
95 
the aid of genetically encoded calcium indicator GCamp6f. Furthermore, the 
96 
implementation of flashed fluorescence excitation (200 s in duration) allowed blur-free 
97 
fluorescent images to be captured when a zebrafish moved at a speed up to 10 mm/s. The 
98 
seamless integration of the tracking and imaging system made it possible to reveal rich 
99 
whole brain neural dynamics during natural behavior with unprecedented resolution. We 
100 
demonstrated the ability of our system during visually evoked and prey capture behaviors 
101 
in larval zebrafish. 
102 
 
103 
Results: 
104 
The newly developed XLFM is based on the general principle of light field [26] and can 
105 
acquire 3D information from a single camera frame. XLFM greatly relaxed the constraint 
106 
imposed by the tradeoff between spatial resolution and imaging volume coverage in 
107 
conventional LFM. This achievement relies on optics and in computational 
108 
reconstruction techniques. First, a customized lenslet array (Figure 1a, Figure 1-figure 
109 
supplement 1) was placed at the rear pupil plane of the imaging objective, instead of at 
110 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  6 / 55 
 
the imaging plane as in LFM. Therefore, in ideal conditions, a spatially invariant point 
111 
spread function (PSF) could be defined and measured. In practice, the PSF was 
112 
approximately spatially invariant, as discussed below. Second, the aperture size of each 
113 
micro-lens was decoupled from their interspacing and spatial arrangement, so that both 
114 
the imaging volume and the resolution could be optimized simultaneously given the 
115 
limited imaging sensor size. Third, multifocal imaging [27, 28] was introduced to further 
116 
increase the depth of view by dividing the micro-lenses array into several groups whose 
117 
focal planes were at different axial positions (Figures 1b & c, Figure 1-figure 
118 
supplements 3 & 4). Fourth, a new computational algorithm based on optical wave theory 
119 
was developed to reconstruct the entire 3D volume from one image (Figure 1-figure 
120 
supplement 5) captured by a fast camera (see Methods).  
121 
 
122 
We characterized the XLFM by imaging 0.5 m diameter fluorescent beads. In our 
123 
design, the system had ~ Ø800 m in plane coverage (Ø is the diameter of the lateral 
124 
field of view) and more than 400 m depth of view, within which an optimal resolution 
125 
of 3.4 m × 3.4 m × 5 m could be achieved over a depth of 200 m (Figure 1-figure 
126 
supplements 6 & 7, Methods) when sample was sparse. In the current implementation, 
127 
however, the imaging performance suffered from variation in the focal length of the 
128 
micro-lenses (Figure 1-figure supplement 8) and the optimal resolution at 3.4 m × 3.4 
129 
m × 5 m was preserved over a reduced volume of Ø500 m × 100 m (Figure 1-figure 
130 
supplements 9 & 10). Beyond this volume, the resolution degraded gradually. To 
131 
minimize the reconstruction time while assuring whole brain coverage (~ 250 m thick), 
132 
all imaging reconstructions were carried out over a volume of Ø800 m × 400 m.  
133 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  7 / 55 
 
 
134 
The achievable optimal resolution also relies on the sparseness of the sample, because the 
135 
information captured by the image sensor was insufficient to assign independent values 
136 
for all voxels in the entire reconstructed imaging volume. Given the total number of 
137 
neurons (~ 80,000 [29]) in a larval zebrafish brain, we next introduced a sparseness index 
138 
, defined as the fraction of neurons in the brain active at a given instant, and used 
139 
numerical simulation to characterize the dependence of achievable resolution on . We 
140 
identified a critical c  0.11, below which active neurons could be resolved at the 
141 
optimal resolution (Figure 1-figure supplement 11b). As  increased, closely clustered 
142 
neurons could no longer be well resolved (Figure 1-figure supplements 11c-d). Therefore, 
143 
sparse neural activity is a prerequisite in XLFM for resolving individual neurons at the 
144 
optimal resolution. Moreover, the above characterization assumed an aberration and 
145 
scattering free environment; complex optical properties of biological tissue could also 
146 
degrade the resolution [30]. 
147 
 
148 
We demonstrated the capabilities of XLFM by imaging the whole brain neuronal 
149 
activities of a larval zebrafish (5 d post-fertilization (dpf)) at a speed of 77 volumes/s and 
150 
relatively low excitation laser exposure of 2.5 mW/mm2 (Figure 1d, Video 1). The 
151 
fluorescent intensity loss due to photobleaching reached ~ 50% when the zebrafish, 
152 
which expressed pan-neuronal nucleus-labelled GCamp6f (huc:h2b-gcamp6f), was 
153 
imaged continuously for ~ 100 min and over more than 300,000 volumes (Figure 1-figure 
154 
supplement 12, Videos 2 & 3). To test whether XLFM could monitor fast changes in 
155 
neuronal dynamics across the whole brain at high resolution (close to single neuron 
156 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  8 / 55 
 
level), we first presented the larval zebrafish, restrained in low melting point agarose, 
157 
with visual stimulation (~ 2.6 s duration). We found that different groups of neurons in 
158 
the forebrain, midbrain, and hindbrain were activated at different times (Figures 1e–f, 
159 
Videos 1 & 4), suggesting rapid sensorimotor transformation across different brain 
160 
regions.  
 
161 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  9 / 55 
 
 
162 
Figure 1. Whole brain imaging of larval zebrafish with XLFM. (a) Schematic of XLFM. 
163 
Lenslet array position was conjugated to the rear pupil plane of the imaging objective. 
164 
Excitation laser (blue) provided uniform illumination across the sample. (b–c) Point 
165 
sources at two different depths formed, through two different groups of micro-lenses, 
166 
sharp images on the imaging sensor, with positional information reconstructed from these 
167 
distinct patterns. (d) Maximum intensity projections (MIPs) on time and space of time 
168 
series volume images of an agarose-restrained larval zebrafish with pan-neuronal 
169 
nucleus-localized GCaMP6f (huc:h2b-gcamp6f) fluorescence labeling. (e) Normalized 
170 
neuronal activities of selected neurons exhibited increasing calcium responses after the 
171 
onset of light stimulation at t = 0. Neurons were ordered by the onset time when the 
172 
measured fluorescence signals reached 20% of their maximum. (f) Selected neurons in (e) 
173 
were color coded based on their response onset time. Scale bar is 100 m. 
 
174 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  10 / 55 
 
To track freely swimming larval zebrafish, we transferred fish into a water-filled chamber 
175 
with a glass ceiling and floor. The 20 mm  20 mm  0.8 mm-sized chamber was coupled 
176 
with a piezo actuator and mounted on a high-speed 2D motorized stage (Figure 2). A 
177 
tracking camera monitored the lateral movement of the fish, and an autofocus camera, 
178 
which captured light field images, monitored the axial movement of the fish head (Figure 
179 
2, Figure 2-figure supplement 1). 
180 
 
 
181 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  11 / 55 
 
 
182 
Figure 2. System schematics that integrated tracking, whole brain functional imaging, and 
183 
real time behavioral analysis. Larval zebrafish swam in a customized chamber with an 
184 
optically transparent ceiling and floor. The water-filled chamber was mounted on a high-
185 
speed three-axis stage (PI M686 & PI P725KHDS). Customized LED rings generated 
186 
dark field illumination of the zebrafish. The scattered light was collected by four cameras: 
187 
two cameras below the chamber were used for x-y plane tracking and low magnification 
188 
real-time (RT) analysis, respectively; two cameras above the chamber and after the 
189 
imaging objective were used for Z autofocus and high magnification RT analysis. The 
190 
positional information of the larval zebrafish, acquired from the tracking and autofocus 
191 
system, was converted to feedback voltage signals to drive the three-axis stage and to 
192 
compensate for fish movement. The functional imaging system, described in Figure 1, 
193 
shared the same imaging objective placed above the swimming chamber. The 3D 
194 
tracking, RT behavioral analysis, and functional imaging system were synchronized for 
195 
accurate correlation between neural activity and behavioral output. 
 
196 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  12 / 55 
 
Real-time machine vision algorithms allowed quick estimate of lateral (within 1 ms) and 
197 
axial (~ 5 ms) head positions (see Methods). The error signals in three dimensions, 
198 
defined as the difference between the head position and set point, were calculated (Figure 
199 
3a) and converted to analog voltage signals through proportional-integral-derivative (PID) 
200 
control to drive the motorized stage and z-piezo scanner. Tracking and autofocusing 
201 
allowed for rapid compensation of 3D fish movement (300 Hz in x and y, 100 Hz in z, 
202 
Figure 3a) and retainment of the fish head within the field of view of the imaging 
203 
objective.  
204 
 
205 
Our tracking system permitted high-speed and high-resolution recording of larval 
206 
zebrafish behaviors. With two cameras acquiring head and whole body videos 
207 
simultaneously (Figure 2, Figure 3b), we recorded and analyzed in real time (see 
208 
Methods) the kinematics of key features during larval zebrafish prey capture (Figures 3b 
209 
& c, Videos 5 & 6). Consistent with several earlier findings [16-18], eyes converged 
210 
rapidly when the fish entered the prey capture state (Figure 3c). Other features that 
211 
characterized tail and fin movement were also analyzed at high temporal resolution 
212 
(Figure 3c).  
213 
 
214 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  13 / 55 
 
 
215 
Figure 3. 3D tracking of larval zebrafish. (a) Representative time varying error signals in 
216 
three dimensions, defined as the difference between real head position and set point. Inset 
217 
provides magnified view at short time interval. Lateral movement can be rapidly 
218 
compensated for within a few milliseconds with an instantaneous velocity of up to 10 
219 
mm/s. The axial shift was small compared with the depth coverage (200 m) during 
220 
whole brain imaging, and thereby had minor effect on brain activity reconstruction. (b) 
221 
Tracking images at four time points during prey capture behavior, acquired at low (left) 
222 
and high (right) magnification simultaneously. Scale bars are 1 mm (left) and 200 m 
223 
(right). (c) Kinematics of behavioral features during prey capture. Shaded region marks 
224 
the beginning and end of the prey capture process. 
 
225 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  14 / 55 
 
The integration of the XLFM and 3D tracking system allowed us to perform whole brain 
226 
functional imaging of a freely behaving larval zebrafish (Figure 2). We first replicated the 
227 
light-evoked experiment (similar to Figure 1), albeit in a freely behaving zebrafish with 
228 
pan-neuronal cytoplasm-labeled GCaMP6s (huc:gcamp6s), which exhibited faster and 
229 
more prominent calcium response (Video 7). Strong activities were observed in the 
230 
neuropil of the optical tectum and the midbrain after stimulus onset. The fish tried to 
231 
avoid strong light exposure and made quick tail movement at ~ 60 Hz. Whole brain 
232 
neural activity was monitored continuously during the light-evoked behavior, except for 
233 
occasional blurred frames due to the limited speed and acceleration of the tracking stage. 
234 
 
235 
Next, we captured whole brain neural activity during the entire prey capture process in 
236 
freely swimming larval zebrafish (huc:gcamp6s, Video 8). When a paramecium moved 
237 
into the visual field of the fish, groups of neurons, indicated as group 1 in Figure 4b, near 
238 
the contralateral optical tectum of the fish were first activated (t1). The fish then 
239 
converged its eyes onto the paramecium and changed its heading direction in approach 
240 
(t2). Starting from t2, several groups of neurons in the hypothalamus, midbrain, and 
241 
hindbrain, highlighted as groups 2, 3, and 4 in Figure 4b, were activated. It took the fish 
242 
three attempts (Figure 4c) to catch and eat the paramecium. After the last try (t4), neuron 
243 
activity in group 1 decreased gradually, whereas activities in the other groups of neurons 
244 
continued to rise and persisted for ~ 1 s before the calcium signals decreased. The earliest 
245 
tectal activity (group 1) responsible for prey detection found here is consistent with 
246 
previous studies [31, 32]. Moreover, our data revealed interesting neural dynamics arising 
247 
from other brain regions during and after successful prey capture. We also monitored 
248 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  15 / 55 
 
similar behavior in a zebrafish expressing nucleus-localized GCamp6f (huc:h2b-gcamp6f) 
249 
with better resolution but less prominent calcium response (Video 9).  
250 
 
 
251 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  16 / 55 
 
 
252 
Figure 4. Whole brain imaging of larval zebrafish during prey capture behavior. (a) 
253 
Renderings of whole brain calcium activity at six time points (up) and the corresponding 
254 
behavioral images (bottom). Features used to quantify behavior were: fish-paramecium 
255 
azimuth ; convergence angle between eyes ; head orientation ; and fish-paramecium 
256 
distance d. (b) Maximum intensity projections of zebrafish brain with pan-neuronal 
257 
cytoplasm-labeled GCaMP6s (huc:gcamp6s). Boundaries of four brain regions are color 
258 
marked. (c) Neural dynamics inferred from GCaMP6 fluorescence changes in these four 
259 
regions during the entire prey capture behavior (up) and the kinematics of behavioral 
260 
features (bottom). Note that between t2 and t4, fish-paramecium distance d exhibits three 
261 
abrupt kinks, representing the three attempts to catch prey. 
 
262 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  17 / 55 
 
Discussion: 
263 
Whole brain imaging in freely behaving animals has been previously reported in 
264 
Caenorhabditis elegans, by integrating spinning-disk confocal microscopy with a 2D 
265 
tracking system [33, 34]. In the more remote past, Howard Berg pioneered the use of 3D 
266 
tracking microscopy to study bacteria chemotaxis [35]. However, the significant increase 
267 
of animal size imposes challenges both in tracking and imaging technologies. The XLFM, 
268 
derived from the general concept of light field imaging [21, 26, 36, 37], overcomes 
269 
several critical limitations of conventional LFM and allows optimization of imaging 
270 
volume, resolution, and speed simultaneously. Furthermore, it can be perfectly combined 
271 
with flashed fluorescence excitation to capture blur-free images at high resolution during 
272 
rapid fish movement. Taken together, we have developed a volume imaging and tracking 
273 
microscopy system suitable for observing and capturing freely behaving larval zebrafish, 
274 
which have ~ 80,000 neurons and can move two orders of magnitude faster than C. 
275 
elegans.  
276 
 
277 
Tracking and whole brain imaging of naturally behaving zebrafish provide an additional 
278 
way to study sensorimotor transformation across the brain circuit. A large body of 
279 
research suggests that sensory information processing depends strongly on the locomotor 
280 
state of an animal [38-40]. The ability to sense self-motion, such as proprioceptive 
281 
feedback [41] and efferent copy [42], can also profoundly shape the dynamics of the 
282 
neural circuit and perception. To explore brain activity in swimming zebrafish, several 
283 
studies have utilized an elegant tail-free embedding preparation [25, 43, 44], in which 
284 
only the head of the fish is restrained in agarose for functional imaging. Nevertheless, it 
285 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  18 / 55 
 
would be ideal to have physiological access to all neurons in defined behavioral states, 
286 
where all sensory feedback loops remain intact and functional. Our XLFM-3D tracking 
287 
system is one step towards this goal, and could be better exploited to explore the neural 
288 
basis of more sophisticated natural behaviors, such as prey capture and social interaction, 
289 
where the integration of multiple sensory feedbacks becomes critical. 
290 
 
291 
In the XLFM, the camera sensor size limited the number of voxels and hence the number 
292 
of neurons that could be reliably reconstructed. Our simulation suggested that the 
293 
sparseness of neuronal activities is critical for optimal imaging volume reconstruction. A 
294 
growing body of experimental data indeed suggests that population neuronal activities are 
295 
sparse [45, 46] and sparse representation is useful for efficient neural computation [47, 
296 
48]. Given the total number of neurons in the larval zebrafish brain, we found that when 
297 
the fraction of active neurons in a given imaging frame was less than c  0.11, individual 
298 
neurons could be resolved at optimal resolution. When population neural activity was 
299 
dense (e.g., neurons have high firing rate and firing patterns have large spatiotemporal 
300 
correlation), we obtained a coarse-grained neural activity map with reduced resolution. 
301 
 
302 
To retain the fish head within the field of view of the imaging objective, our tracking 
303 
system compensated for fish movement by continuously adjusting the lateral positions of 
304 
the motorized stage. As a result, self-motion perceived by the fish was not exactly the 
305 
same as that during natural behaviors. The linear acceleration of the swimming fish, 
306 
encoded by vestibular feedback, was significantly underestimated. The perception of 
307 
angular acceleration during head orientation remained largely intact. The relative flow 
308 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  19 / 55 
 
velocity along the fish body, which was invariant upon stage translation, can still be 
309 
detected by specific hair cells in the lateral line system [49, 50]. Together, the 
310 
interpretation of brain activity associated with self-motion must consider motion 
311 
compensation driven by the tracking system. 
312 
 
313 
Both tracking and imaging techniques can be improved in the future. For example, the 
314 
current axial displacement employed by the piezo scanner had a limited travelling range 
315 
(400 µm), and our swimming chamber essentially restrained the movement of the 
316 
zebrafish in two dimensions. This limitation could be relaxed by employing axial 
317 
translation with larger travelling range and faster dynamics. Furthermore, to avoid any 
318 
potential disturbance of animal behaviors, it would be ideal if the imaging system moved, 
319 
instead of the swimming chamber.  
320 
 
321 
In XLFM, the performance degradation caused by focal length variation of the micro-
322 
lenses could be resolved by higher precision machining. In addition, the capability of 
323 
XLFM could be further improved with the aid of technology development in other areas. 
324 
With more pixels in the imaging sensor, we could resolve more densely labelled samples, 
325 
and achieve higher spatial resolution without sacrificing imaging volume coverage by 
326 
introducing more than two different focal planes formed by more groups of micro-lenses. 
327 
With better imaging objectives that could provide higher numerical aperture and larger 
328 
field of view at the same time, we could potentially image the entire nervous system of 
329 
the larval zebrafish with single neuron resolution in all three dimensions. Additionally, 
330 
the fast imaging speed of XLFM holds the potential for recording electrical activity when 
331 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  20 / 55 
 
high signal-to-noise ratio (SNR) fluorescent voltage sensors become available [51]. 
332 
Finally, the illumination-independent characteristic of XLFM is perfectly suitable for 
333 
recording brain activities from bioluminescent calcium/voltage indicators in a truly 
334 
natural environment, where light interference arising from fluorescence excitation can be 
335 
eliminated [19]. 
336 
 
 
337 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  21 / 55 
 
METHODS 
338 
XLFM 
339 
The imaging system (Figure 1) was a customized upright microscope. Along the 
340 
fluorescence excitation light path, a blue laser (Coherent, OBIS 488 nm, 100 mW, USA) 
341 
was expanded and collimated into a beam with a diameter of ~ 25 mm. It was then 
342 
focused by an achromatic lens (focal length: 125 mm) and reflected by a dichroic mirror 
343 
(Semrock, Di02-R488-25x36, USA) into the back pupil of the imaging objective 
344 
(Olympus, XLPLN25XWMP2, 25X, NA 1.05, WD 2mm, Japan) to result in an 
345 
illumination area of ~1.44 mm in diameter near the objective’s focal plane. In the 
346 
fluorescence imaging light path, excited fluorescence was collected by the imaging 
347 
objective and transmitted through the dichroic mirror. A pair of achromatic lenses (focal 
348 
lengths: F1 = 180 mm & F2 = 160 mm), arranged in 2F1 + 2F2, were placed after the 
349 
objective and dichroic mirror to conjugate the objective’s back pupil onto a customized 
350 
lenslet array (Figure 1-figure supplement 1). The customized lenslet array was an 
351 
aluminum plate with 27 holes (1.3 mm diameter aperture on one side and 1 mm diameter 
352 
aperture on the other side, Source Code File 1) housing 27 customized micro-lenses (1.3 
353 
mm diameter, focal length: 26 mm). The 27 micro-lenses were divided into two groups 
354 
(Figure 1-figure supplement 1) and an axial displacement of 2.5 mm was introduced 
355 
between them. Due to the blockage of light by the aluminum micro-lenses housing, 16% 
356 
of the light after a 1.05 NA imaging objective was effectively collected by the camera. 
357 
This efficiency is equivalent to using a 0.4 NA imaging objective. Finally, the imaging 
358 
sensor of a sCMOS camera (Hamamatsu, Orca-Flash 4.0 v2, Japan) was placed at the 
359 
middle plane between two focal planes formed by two different groups of micro-lenses. 
360 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  22 / 55 
 
The total magnification of the imaging system was ~ 4, so one camera pixel (6.5 µm) 
361 
corresponded to ~1.6 µm on the sample. 
362 
 
363 
We developed a computational algorithm for 3D volume reconstruction, which required 
364 
an accurately measured PSF (Figure 1-figure supplement 2). The PSF was measured by 
365 
recording images of a 500 nm diameter fluorescent bead sitting on a motorized stage 
366 
under the objective. A stack of 200 images was recorded when the bead was scanned with 
367 
a step size of 2 µm in the axial direction from 200 µm below the objective’s focal plane 
368 
to 200 µm above. Since the images formed by two different groups of micro-lenses were 
369 
from different axial locations and had different magnifications, the measured raw PSF 
370 
data were reorganized into two complementary parts: PSF_A and PSF_B (Figure 1-figure 
371 
supplements 3 & 4), according to the spatial arrangement of the micro-lenses. We took 
372 
PSF_A stack, PSF_B stack, and a single frame of a raw image (2048 × 2048 pixels) as 
373 
inputs, and applied a newly developed algorithm to reconstruct the 3D volume. 
374 
 
375 
Image reconstruction of XLFM 
376 
The reconstruction algorithm was derived from the Richardson-Lucy deconvolution. The 
377 
goal was to reconstruct a 3D fluorescent object from a 2D image: 
378 
�����, �, �� 
The algorithm assumes that the real 3D object can be approximated by a discrete number 
379 
of x-y planes at different z positions: 
380 
�����, �, ��~�����, �, ���, where � � 1,2 . . � 
381 
The numbers and positions of these planes can be arbitrary, yet the Nyquist sampling rate 
382 
should be chosen to optimize the speed and accuracy of the reconstruction.  
383 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  23 / 55 
 
As the imaging system consisted of two different groups of micro-lenses (Figure 1-figure 
384 
supplement 1), their PSFs (Figure 1-figure supplements 3 & 4) each consisted of a stack 
385 
of planes that were measured at the same chosen axial positions ��: 
386 
���
���, �, ��� & ���
���, �, ���, 
387 
Although the PSF was measured in imaging space, here we denote x and y as coordinates 
388 
in object space to follow conventions in optical microscopy. Here and below, the 
389 
combination of PSFA and PSFB is the total PSF.  
390 
 
391 
Additionally, the images formed by two different groups of micro-lenses had different 
392 
magnifications, which could be determined experimentally. The ratio between two 
393 
different magnifications can be defined as: 
394 
� � ������������� �� ����� � �����������
������������� �� ����� � ����������� 
Then the captured image on the camera can be estimated as: 
395 
��������, �� � ��������, �, ���⨂���
���, �, ��� � ������, �, ���⨂������, �, ����,
�
���
 
where ������, �, ��� � �������, ��, ��� 
396 
The operator ⨂ represents 2D convolution. Here, x and y on the left hand side of the 
397 
equation also represent coordinates in object space so that 2D convolution was carried 
398 
out in the same coordinates. 
399 
 
400 
The goal of the algorithm is to estimate the �����, �, ��� from the measured camera 
401 
frame: 
402 
���������, �� 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  24 / 55 
 
According to the Richardson-Lucy deconvolution algorithm, the iterative reconstruction 
403 
can be expressed as: 
404 
������
�
��, �� � ������
�����, �, ���⨂���
���, �, ��� � ����
�����, �, ���⨂������, �, ����
�
���
 
����
�����, �, ��� � ����
�����, �, ��� ����������, ��
������
�
��, �� ⨂���
����, ��, ���� 
����
�����, �, ��� � ����
�����, �, ��� ����������, ��
������
�
��, �� ⨂�������, ��, ���� 
����
� ��, �, ��� � ���������
�����, �, ��� � �1 � ����������
������, ��, ��� 
����
� ��, �, ��� � ���������
��� ��
� , �
� , ��� � �1 � ����������
�����, �, ��� 
Here 0 � ����� � 1 is the weighting factor at different axial positions. The choice of 
405 
����� can be arbitrary. Because the resolutions achieved by different groups of micro-
406 
lenses at different z positions were not the same, the weighting factor can take this effect 
407 
into consideration by weighing higher quality information more than lower quality 
408 
information. One simple choice is ����� � 0.5, that is, to weigh information from two 
409 
groups of micro-lenses equally.  
410 
 
411 
The starting estimate of the object can be any non-zero value. Near the end of the 
412 
iterations, ����
� ��, �, ��� and ����
� ��, �, ��� are interchangeable, except with different 
413 
magnifications. Either can be used as the resulting estimate of the 3D object. 
414 
 
415 
In XLFM, together with its reconstruction algorithm, the diffraction of the 3D light field 
416 
is properly considered by experimentally measured PSF. The raw imaging data can be fed 
417 
into the algorithm directly without any preprocessing. Given that the PSF is spatially 
418 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  25 / 55 
 
invariant, which is satisfied apart from small aberrations, the algorithm can handle 
419 
overlapping fish images (Figure 1-figure supplement 5). As a result, the field of view can 
420 
be increased significantly. The reconstruction algorithm was typically terminated after 30 
421 
iterations when modifications in the estimated object became very small. The 
422 
computation can speed up significantly via GPU. It took about 4 min to reconstruct one 
423 
3D volume using a desktop computer with a GPU (Nvidia Titan X). In comparison, the 
424 
reconstruction ran ~20× slower using a CPU (Intel E5-2630v2) on a Dell desktop. The 
425 
source code written in MATLAB can be found in the Source Code File 2. 
426 
 
427 
The 3D deconvolution method has been developed for conventional LFM [21]. Our 
428 
method differs from [21] in several ways. (1) The optical imaging systems are different. 
429 
(2) The definitions of PSFs are different. Ours defines a spatially invariant PSF (see 
430 
below for detailed characterization), whereas [21] defined a spatially variant PSF, leading 
431 
to increased computational complexity in the deconvolution algorithm. (3) The PSF in 
432 
[21] was simulated based on a model derived from an ideal imaging system, whereas ours 
433 
was measured experimentally. Furthermore, our system took practical conditions, such as 
434 
a non-ideal imaging objective, actual positions of microlenses, the spectrum of received 
435 
fluorescence signal et al., into consideration.  
436 
 
437 
Resolution characterization of XLFM 
438 
Unlike conventional microscopy, where the performance of the imaging system is fully 
439 
characterized by the PSF at the focal plane, the capability of XLFM is better 
440 
characterized as a function of positions throughout the imaging volume. 
441 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  26 / 55 
 
 
442 
We first characterized the spatial resolution in the x-y plane by analyzing the spatial 
443 
frequency support of the experimentally measured PSF from individual micro-lenses 
444 
using a 0.5 µm diameter fluorescent bead. The optical transfer function (OTF), which is 
445 
the Fourier transform of the PSF in the x-y plane, was extended to a spatial frequency of 
446 
~1/3.4 µm-1 (Figure 1-figure supplement 6), a result that agreed well with the designed 
447 
resolution at 3.4 μm, given that the equivalent NA of individual micro-lenses was 0.075.  
448 
 
449 
The lateral resolution, measured from the raw PSF behind individual micro-lenses, was 
450 
preserved across the designed cylindrical imaging volume of Ø800 μm × 200 μm (Figure 
451 
1-figure supplement 6). However, the reconstruction results (Figure 1-figure supplement 
452 
9), which used total PSF (Figure 1-figure supplement 2), exhibited resolution degradation 
453 
when the fluorescent bead was placed more than 250 μm away from the center (Figure 1-
454 
figure supplement 9). This discrepancy resulted from the variation in focal length of the 
455 
micro-lenses (Figure 1-figure supplement 8), which, in turn, led to spatial variance of the 
456 
defined PSFA and PSFB. In principle, the designed lateral resolution of 3.4 µm could be 
457 
preserved over a volume of Ø800 μm × 200 μm by reducing focal length variation to 
458 
below 0.3%  
459 
 
460 
We next characterized the axial resolution of the XLFM. The XLFM gained axial 
461 
resolution by viewing the object from large projection angles achieved by micro-lenses 
462 
sitting near the edge of the objective’s back pupil plane. For example, if two points of 
463 
light source were located at the same position in the X-Y plane, but were separated by ∆� 
464 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  27 / 55 
 
in the axial direction, then one micro-lens in the XLFM could capture an image of these 
465 
two points with a shift between them. The shift can be determined as: 
466 
� � ∆� ∗ ����, 
467 
where �  is the inclination angle inferred from the measured PSF (Figure 1-figure 
468 
supplement 2). If the two points in the image can be resolved, the two points separated by 
469 
∆� can be resolved by the imaging system. Since a micro-lens sitting in the outer layer of 
470 
the array offered the largest inclination angle of 40 degree in our system, the axial 
471 
resolution dz can be directly calculated as: 
472 
�� �
���
�������
� 3.4 ��
��� 
�40°� � 4 �� 
The best way to confirm the theoretical estimate is to image two fluorescent beads with 
473 
precisely controlled axial separations. However, this is technically very challenging. 
474 
Instead, we pursued an alternative method that is equivalent to imaging two beads 
475 
simultaneously:  
476 
(1) We took a z stack of images of fluorescent beads, as done in measuring the PSF. 
477 
(2) In post processing, we added two images from different z positions to mimic the 
478 
beads being present simultaneously at two different z positions. 
479 
 
480 
The above method allowed us to experimentally characterize the axial resolution afforded 
481 
by individual micro-lenses focusing at different z positions. We used a single fluorescent 
482 
bead (0.5 μm in diameter) with a high SNR (Figure 1-figure supplement 7a). We imaged 
483 
at different axial positions: z = -100 μm, z = 0 μm, and z = 100 μm (Figure 1-figure 
484 
supplement 7b). The third column is the combined images in column 1 & 2. The 
485 
capability of resolving the two beads in the third column can be demonstrated by spatial 
486 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  28 / 55 
 
frequency analysis (fourth column in Figure 1-figure supplement 7b). The two line dips, 
487 
indicating the existence of two beads instead of one rod in the fourth column, were 
488 
confirmations of the resolving capability. This becomes more evident after deconvolution 
489 
of the raw images (fifth column in Figure 1-figure supplement 7b). Micro-lenses 1 and 2 
490 
could resolve two beads, separated by 5μm, within the range of �100 μm � � � 0 and 
491 
0 � � � 100 μm, respectively. In other words, the complementary information provided 
492 
by the two micro-lenses allowed the system to maintain a high axial resolution at 5 μm 
493 
across a 200 μm depth. 
494 
 
495 
Next, we imaged densely packed fluorescent beads (0.5 μm in diameter) with a low SNR 
496 
(Figure 1-figure supplement 10a), and used our reconstruction algorithm to determine the 
497 
minimum axial separation between beads that could be resolved (Figure 1-figure 
498 
supplements 10b–c). In this case, 5 μm axial resolution could be preserved across a depth 
499 
of 100 μm. The resolution decayed gradually to ~10 μm at the edge of an imaging 
500 
volume with a 400 μm axial coverage (Figure 1-figure supplement 10b). We believe that 
501 
the optimal axial resolution at 5 µm could be achieved over an axial coverage of 200 μm 
502 
by minimizing micro-lens focal length variation (Figure 1-figure supplement 8).  
503 
 
504 
Finally, we characterized how the imaging performance depended upon the sparseness of 
505 
the sample. Given the total number of neurons (~ 80,000) in a larval zebrafish brain, we 
506 
introduced a sparseness index , defined as the fraction of neurons in the brain active at 
507 
an imaging frame, and used numerical simulation to characterize the dependence of 
508 
achievable resolution on . To this end, we simulated a zebrafish larva with uniformly 
509 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  29 / 55 
 
distributed firing neurons (red dots in Figure 1-figure supplement 11a). By convolving 
510 
the simulated zebrafish with the experimentally measured PSFs (Figure 1-figure 
511 
supplements 3 & 4), we generated an image that mimicked the raw data captured by the 
512 
camera. We then reconstructed the simulated neurons from this image, represented by 
513 
green dots. When  was equal to or less than 0.11, which corresponded to ~ 9000 neurons 
514 
activated at a given instant, all active neurons, including those closely clustered, could be 
515 
reconstructed with optimal resolution (Figure 1-figure supplement 11b inset). As the 
516 
sparseness index  increased, the resolution degraded: nearby neurons merged laterally 
517 
and elongated axially (Figure 1-figure supplements 11c–d). In all calculations, the 
518 
Poisson noise was properly considered by assuming that each active neuron emitted 
519 
20,000 photons, 2.2% of which were collected by our imaging system. 
520 
 
521 
In vivo resolution characterization is challenging due to a lack of bright and spot-like 
522 
features in living animals. Additionally, achievable resolution depends on the optical 
523 
properties of biological tissues, which can be highly heterogeneous and difficult to infer. 
524 
The light scattering and aberration induced by biological tissue usually leads to degraded 
525 
imaging performance [30, 52-54].  
526 
 
527 
XY tracking system  
528 
To compensate for lateral fish movement and retain the entire fish head within the field 
529 
of view of a high NA objective (25×, NA = 1.05), a high-speed camera was used to 
530 
capture fish motion (2 ms exposure time, 300 fps or higher, Basler aca2000-340kmNIR, 
531 
Germany). We developed an FPGA-based RT system in LabVIEW that could rapidly 
532 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  30 / 55 
 
identify the head position by processing the pixel stream data within the Cameralink card 
533 
before the whole image was transferred to RAM. The error signal between the actual 
534 
head position and the set point was then fed into the PID to generate output signals and 
535 
control the movement of a high-speed motorized stage (PI M687 ultrasonic linear motor 
536 
stage, Germany). In the case of large background noise, we alternatively performed 
537 
conventional imaging processing in C/C++ (within 1 ms delay). The rate-limiting factor 
538 
of our lateral tracking system was the response time of the stage (~ 300 Hz).   
539 
 
540 
Autofocus system 
541 
We applied the principle of LFM to determine the axial movement of larval zebrafish. 
542 
The autofocus camera (100 fps, Basler aca2000-340kmNIR, Germany) behind a one-
543 
dimensional micro-lens array captured triplet images of the fish from different 
544 
perspectives (Figure 2-figure supplement 1a). Z motion caused an extension or 
545 
contraction between the centroids of the fish head in the left and right sub-images, an 
546 
inter-fish distance (Figure 2-figure supplement 1b) that can be accurately computed from 
547 
image autocorrelation. The inter-fish distance, multiplied by a pre-factor, can be used to 
548 
estimate the z position of the fish, as it varies linearly with axial movement (Figure 2-
549 
figure supplement 1c). The error signal between the actual axial position of the fish head 
550 
and the set point was then fed into the PID to generate an output signal to drive a piezo-
551 
coupled fish container. The feedback control system was written in LabVIEW. The code 
552 
was further accelerated by parallel processing and the closed loop delay was ~ 5 ms. The 
553 
rate-limiting factor of the autofocus system was the settling time of the piezo scanner (PI 
554 
P725KHDS, Germany, 400 m travelling distance), which was about 10 ms. 
555 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  31 / 55 
 
 
556 
Real-time behavioral analysis  
557 
Two high-speed cameras acquired dark-field images at high and low magnification, 
558 
respectively, and customized machine vision software written in C/C++ with the aid of 
559 
OpenCV library was used to perform real-time behavioral analysis of freely swimming 
560 
larval zebrafish. At high magnification, eye positions, their orientation, and convergence 
561 
angle were computed; at low magnification, the contour of the whole fish, centerline, 
562 
body curvature, and bending angle of the tail were computed. The high mag RT analysis 
563 
was run at ~ 120 fps and the low mag RT analysis was run at ~ 180 fps. The source code 
564 
can be found in the Source Code File 3. 
565 
 
566 
Ethics statement and animal handling  
567 
All animal handling and care were conducted in strict accordance with the guidelines and 
568 
regulations set forth by the Institute of Neuroscience, Chinese Academy of Sciences, 
569 
University of Science and Technology of China (USTC) Animal Resources Center, and 
570 
University Animal Care and Use Committee. The protocol was approved by the 
571 
Committee on the Ethics of Animal Experiments of the USTC (permit number: 
572 
USTCACUC1103013).  
573 
 
574 
All larval zebrafish (huc:h2b-gcamp6f and huc:gcamp6s) were raised in embryo medium 
575 
under 28.5ºC and a 14/10 h light/dark cycle. Zebrafish were fed with paramecium from 4 
576 
dpf. For restrained experiments, 4–6 dpf zebrafish were embedded in 1% low melting 
577 
point agarose. For freely moving experiments, 7–11 dpf zebrafish with 10% Hank’s 
578 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  32 / 55 
 
solution were transferred to a customized chamber (20 mm in diameter, 0.8 mm in depth), 
579 
and 10–20 paramecia were added before the chamber was covered by a coverslip.  
580 
 
581 
Neural activity analysis 
582 
To extract neural activity induced by visual stimuli (Figures 1e & f), time series 3D 
583 
volume stacks were first converted to a single 3D volume stack, in which each voxel 
584 
represented variance of voxel values over time. Candidate neurons were next extracted by 
585 
identifying local maxima in the converted 3D volume stack. The region-of-interest (ROI) 
586 
was set according to the empirical size of a neuron. The voxels around the local maxima 
587 
were selected to represent neurons. The fluorescence intensity over each neuron’s ROI 
588 
was integrated and extracted as neural activity. Relative fluorescent changes ∆�/�
� were 
589 
normalized to their maximum calcium response ∆�
���/�
�  over time, and sorted 
590 
according to their onset time when ∆� first reached 20% of its ∆�
��� (Figures 1e & f) 
591 
after the visual stimulus was presented.  
592 
 
593 
Visual stimulation 
594 
A short wavelength LED was optically filtered (short-pass optical filter with cut-off 
595 
wavelength at 450 nm, Edmund #84-704) to avoid light interference with fluorescence. It 
596 
was then focused by a lens into a spot 2~3 mm in diameter. The zebrafish was 
597 
illuminated from its side. The total power of the beam was roughly 3 mW. 
598 
 
599 
Statement of replicates and repeats in experiments 
600 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  33 / 55 
 
Each experiment was repeated at least three times with similar experimental conditions. 
601 
Imaging and video data acquired from behaviorally active larval zebrafish with normal 
602 
huc:h2b-gcamp6f or huc:gcamp6s expression were used in the main figures and videos.  
603 
 
604 
References: 
605 
1. 
Kerr, J.N.D. and W. Denk, Imaging in vivo: watching the brain in action. Nature 
606 
Reviews Neuroscience, 2008. 9(3): p. 195‐205. 
607 
2. 
Dombeck, D.A., et al., Imaging large‐scale neural activity with cellular 
608 
resolution in awake, mobile mice. Neuron, 2007. 56(1): p. 43‐57. 
609 
3. 
Wyart, C., et al., Optogenetic dissection of a behavioural module in the 
610 
vertebrate spinal cord. Nature, 2009. 461(7262): p. 407‐U105. 
611 
4. 
Boyden, E.S., et al., Millisecond‐timescale, genetically targeted optical control 
612 
of neural activity. Nature Neuroscience, 2005. 8(9): p. 1263‐1268. 
613 
5. 
Zhang, F., et al., Multimodal fast optical interrogation of neural circuitry. 
614 
Nature, 2007. 446(7136): p. 633‐U4. 
615 
6. 
Chen, T.W., et al., Ultrasensitive fluorescent proteins for imaging neuronal 
616 
activity. Nature, 2013. 499(7458): p. 295‐+. 
617 
7. 
Tian, L., et al., Imaging neural activity in worms, flies and mice with improved 
618 
GCaMP calcium indicators. Nature Methods, 2009. 6(12): p. 875‐U113. 
619 
8. 
Luo, L., E.M. Callaway, and K. Svoboda, Genetic dissection of neural circuits. 
620 
Neuron, 2008. 57(5): p. 634‐660. 
621 
9. 
Friedrich, R.W., G.A. Jacobson, and P. Zhu, Circuit neuroscience in zebrafish. 
622 
Curr Biol, 2010. 20(8): p. R371‐81. 
623 
10. 
Ahrens, M.B. and F. Engert, Large‐scale imaging in small brains. Curr Opin 
624 
Neurobiol, 2015. 32: p. 78‐86. 
625 
11. 
Ahrens, M.B., et al., Brain‐wide neuronal dynamics during motor adaptation in 
626 
zebrafish. Nature, 2012. 485(7399): p. 471‐7. 
627 
12. 
Ahrens, M.B., et al., Whole‐brain functional imaging at cellular resolution using 
628 
light‐sheet microscopy. Nat Methods, 2013. 10(5): p. 413‐20. 
629 
13. 
Engert, F., The big data problem: turning maps into knowledge. Neuron, 2014. 
630 
83(6): p. 1246‐8. 
631 
14. 
Engert, F., Fish in the matrix: motor learning in a virtual world. Front Neural 
632 
Circuits, 2012. 6: p. 125. 
633 
15. 
Bianco, I.H., et al., The tangential nucleus controls a gravito‐inertial vestibulo‐
634 
ocular reflex. Curr Biol, 2012. 22(14): p. 1285‐95. 
635 
16. 
Bianco, I.H., A.R. Kampff, and F. Engert, Prey capture behavior evoked by 
636 
simple visual stimuli in larval zebrafish. Front Syst Neurosci, 2011. 5: p. 101. 
637 
17. 
Patterson, B.W., et al., Visually guided gradation of prey capture movements in 
638 
larval zebrafish. J Exp Biol, 2013. 216(Pt 16): p. 3071‐83. 
639 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  34 / 55 
 
18. 
Trivedi, C.A. and J.H. Bollmann, Visually driven chaining of elementary swim 
640 
patterns into a goal‐directed motor sequence: a virtual reality study of 
641 
zebrafish prey capture. Front Neural Circuits, 2013. 7: p. 86. 
642 
19. 
Naumann, E.A., et al., Monitoring neural activity with bioluminescence during 
643 
natural behavior. Nat Neurosci, 2010. 13(4): p. 513‐20. 
644 
20. 
Muto, A., et al., Real‐time visualization of neuronal activity during perception. 
645 
Curr Biol, 2013. 23(4): p. 307‐11. 
646 
21. 
Broxton, M., et al., Wave optics theory and 3‐D deconvolution for the light field 
647 
microscope. Opt Express, 2013. 21(21): p. 25418‐39. 
648 
22. 
Prevedel, R., et al., Simultaneous whole‐animal 3D imaging of neuronal activity 
649 
using light‐field microscopy. Nat Methods, 2014. 11(7): p. 727‐30. 
650 
23. 
Pégard, N.C., et al., Compressive light‐field microscopy for 3D neural activity 
651 
recording. Optica, 2016. 3(5): p. 517‐524. 
652 
24. 
Nobauer, T., et al., Video rate volumetric Ca2+ imaging across cortex using 
653 
seeded iterative demixing (SID) microscopy. Nat Meth, 2017. 14(8): p. 811‐
654 
818. 
655 
25. 
Severi, K.E., et al., Neural control and modulation of swimming speed in the 
656 
larval zebrafish. Neuron, 2014. 83(3): p. 692‐707. 
657 
26. 
Adelson, E.H. and J.Y.A. Wang, Single Lens Stereo with a Plenoptic Camera. Ieee 
658 
Transactions on Pattern Analysis and Machine Intelligence, 1992. 14(2): p. 
659 
99‐106. 
660 
27. 
Abrahamsson, S., et al., Fast multicolor 3D imaging using aberration‐corrected 
661 
multifocus microscopy. Nat Meth, 2013. 10(1): p. 60‐63. 
662 
28. 
Perwass, C. and L. Wietzke. Single lens 3D‐camera with extended depth‐of‐
663 
field. 2012. 
664 
29. 
Hill, A., et al., Neurodevelopmental defects in zebrafish (Danio rerio) at 
665 
environmentally relevant dioxin (TCDD) concentrations. 
Toxicological 
666 
Sciences, 2003. 76(2): p. 392‐399. 
667 
30. 
Ji, N., Adaptive optical fluorescence microscopy. Nat Meth, 2017. 14(4): p. 374‐
668 
380. 
669 
31. 
Semmelhack, J.L., et al., A dedicated visual pathway for prey detection in larval 
670 
zebrafish. Elife, 2014. 3. 
671 
32. 
Bianco, I.H. and F. Engert, Visuomotor transformations underlying hunting 
672 
behavior in zebrafish. Curr Biol, 2015. 25(7): p. 831‐46. 
673 
33. 
Venkatachalam, V., et al., Pan‐neuronal imaging in roaming Caenorhabditis 
674 
elegans. Proc Natl Acad Sci U S A, 2016. 113(8): p. E1082‐8. 
675 
34. 
Nguyen, J.P., et al., Whole‐brain calcium imaging with cellular resolution in 
676 
freely behaving Caenorhabditis elegans. Proc Natl Acad Sci U S A, 2016. 
677 
113(8): p. E1074‐81. 
678 
35. 
Berg, H.C., How to Track Bacteria. Review of Scientific Instruments, 1971. 
679 
42(6): p. 868‐&. 
680 
36. 
Ng, R., et al., Light Field Photography with a Hand‐held Plenoptic Camera. 
681 
Stanford Tech Report 2005. 
682 
37. 
Levoy, M., et al., Light field microscopy. ACM Trans. on Graphics (Proc. 
683 
SIGGRAPH), 2006. 25: p. 924‐934. 
684 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  35 / 55 
 
38. 
Niell, C.M. and M.P. Stryker, Modulation of visual responses by behavioral state 
685 
in mouse visual cortex. Neuron, 2010. 65(4): p. 472‐9. 
686 
39. 
Maimon, G., A.D. Straw, and M.H. Dickinson, Active flight increases the gain of 
687 
visual motion processing in Drosophila. Nat Neurosci, 2010. 13(3): p. 393‐9. 
688 
40. 
Chiappe, M.E., et al., Walking modulates speed sensitivity in Drosophila motion 
689 
vision. Curr Biol, 2010. 20(16): p. 1470‐5. 
690 
41. 
Pearson, K.G., Proprioceptive regulation of locomotion. Current Opinion in 
691 
Neurobiology, 1995. 5(6): p. 786‐791. 
692 
42. 
Bell, C.C., An Efference Copy Which Is Modified by Reafferent Input. Science, 
693 
1981. 214(4519): p. 450‐453. 
694 
43. 
Portugues, R. and F. Engert, Adaptive locomotor behavior in larval zebrafish. 
695 
Front Syst Neurosci, 2011. 5: p. 72. 
696 
44. 
Portugues, R., et al., Whole‐brain activity maps reveal stereotyped, distributed 
697 
networks for visuomotor behavior. Neuron, 2014. 81(6): p. 1328‐43. 
698 
45. 
Hromadka, T., M.R. Deweese, and A.M. Zador, Sparse representation of sounds 
699 
in the unanesthetized auditory cortex. PLoS Biol, 2008. 6(1): p. e16. 
700 
46. 
Buzsaki, G. and K. Mizuseki, The log‐dynamic brain: how skewed distributions 
701 
affect network operations. Nat Rev Neurosci, 2014. 15(4): p. 264‐78. 
702 
47. 
Olshausen, B.A. and D.J. Field, Emergence of simple‐cell receptive field 
703 
properties by learning a sparse code for natural images. Nature, 1996. 
704 
381(6583): p. 607‐9. 
705 
48. 
Olshausen, B.A. and D.J. Field, Sparse coding of sensory inputs. Curr Opin 
706 
Neurobiol, 2004. 14(4): p. 481‐7. 
707 
49. 
Coombs, S., et al., The lateral line system. Springer handbook of auditory 
708 
research,. 2014, New York: Springer. xiv, 347 pages. 
709 
50. 
Liao, J.C., Organization and physiology of posterior lateral line afferent neurons 
710 
in larval zebrafish. Biol Lett, 2010. 6(3): p. 402‐5. 
711 
51. 
St‐Pierre, F., et al., High‐fidelity optical reporting of neuronal electrical activity 
712 
with an ultrafast fluorescent voltage sensor. Nat Neurosci, 2014. 17(6): p. 
713 
884‐9. 
714 
52. 
Ji, N., D.E. Milkie, and E. Betzig, Adaptive optics via pupil segmentation for 
715 
high‐resolution imaging in biological tissues. Nat Meth, 2010. 7(2): p. 141‐
716 
147. 
717 
53. 
Wang, K., et al., Rapid adaptive optical recovery of optimal resolution over 
718 
large volumes. Nat Meth, 2014. 11(6): p. 625‐628. 
719 
54. 
Wang, K., et al., Direct wavefront sensing for high‐resolution in vivo imaging in 
720 
scattering tissue. Nature Communications, 2015. 6: p. 7276. 
721 
 
722 
 
723 
Acknowledgements 
724 
We thank Misha B. Ahrens for the zebrafish lines. We thank Yong Jiang, Tongzhou Zhao, 
725 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  36 / 55 
 
WenKai Han, Shenqi Fan for assistance in building the 3D tracking system, real time 
726 
behavioral analysis, and larval zebrafish experiments. We thank Dr. Bing Hu and Dr. Jie 
727 
He for his support in zebrafish handling and helpful discussions.  
728 
729 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  37 / 55 
 
Videos: 
730 
 
731 
Video 1| Whole brain functional imaging of larval zebrafish under light stimulation 
732 
Whole brain XLFM imaging of a 5 dpf agarose-embedded larval zebrafish expressing 
733 
nucleus-localized GCamp6f (huc:h2b-gcamp6f). Light stimulation was introduced at time 
734 
point t = 0. Whole brain activity was recorded at 77 volumes/s. 
735 
 
736 
Video 2| Whole brain functional imaging of spontaneous activities of larval 
737 
zebrafish 
738 
Whole brain XLFM imaging of a 5 dpf agarose-embedded larval zebrafish expressing 
739 
nucleus-localized GCamp6f (huc:h2b-gcamp6f). Spontaneous neural activity was 
740 
recorded at 0.6 volumes/s. 
741 
 
742 
Video 3| Whole brain functional imaging of spontaneous activities of larval 
743 
zebrafish  
744 
Whole brain XLFM imaging of a 5 dpf agarose-embedded larval zebrafish expressing 
745 
cytoplasm-labeled GCamp6s (huc:gcamp6s). Spontaneous neural activity was recorded at 
746 
0.6 volumes/s. 
747 
 
748 
Video 4| Whole brain functional imaging of larval zebrafish under light stimulation 
749 
Whole brain XLFM imaging of a 5 dpf agarose-embedded larval zebrafish expressing 
750 
cytoplasm-labeled GCamp6s (huc:gcamp6s). Light stimulation was introduced at time 
751 
point t = 0. Whole brain activity was recorded at 50 volumes/s. 
752 
 
753 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  38 / 55 
 
Video 5| Tracking of larval zebrafish during prey capture behavior at low resolution 
754 
Tracking and real time kinematic analysis of larval zebrafish during prey capture 
755 
behavior at low resolution. Recorded at 190 frames/s.  
756 
 
757 
Video 6| Tracking of larval zebrafish during prey capture behavior at high 
758 
resolution 
759 
Tracking and real time kinematic analysis of larval zebrafish during prey capture 
760 
behavior at high resolution. Recorded at 160 frames/s.  
761 
 
762 
Video 7| Whole brain functional imaging of a freely swimming larval zebrafish 
763 
under light stimulation 
764 
Whole brain XLFM imaging of a 7 dpf freely swimming larval zebrafish expressing 
765 
cytoplasm-labeled GCamp6s (huc:gcamp6s). Light stimulation was introduced at time 
766 
point t = 0. Whole brain activities were recorded at 77 volumes/s and with a flashed 
767 
excitation laser under 0.3 ms exposure time. 
768 
 
769 
Video 8| Whole brain functional imaging of a freely swimming larval zebrafish 
770 
during prey capture behavior  
771 
Whole brain XLFM imaging of an 11 dpf freely swimming larval zebrafish expressing 
772 
cytoplasm-labeled GCamp6s (huc:gcamp6s). The entire process during which the larval 
773 
zebrafish caught and ate the paramecium was recorded. 
774 
 
775 
Video 9| Whole brain functional imaging of a freely swimming larval zebrafish 
776 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  39 / 55 
 
during prey capture behavior  
777 
Whole brain XLFM imaging of a 7 dpf freely swimming larval zebrafish expressing 
778 
nucleus-localized GCamp6f (huc:h2b-gcamp6f). The entire process during which the 
779 
larval zebrafish caught and ate the paramecium was recorded. 
780 
 
 
781 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  40 / 55 
 
Figure 1-figure supplement 1| Customized lenslet array 
782 
 
783 
Customized lenslet array consisted of 27 customized micro-lenses (1.3 mm diameter, 26 
784 
mm focal length) embedded in an aluminum plate with 27 drilled holes (1.3 mm diameter 
785 
aperture on one side and 1 mm diameter aperture on the other side). Micro-lenses were 
786 
divided into two groups (A or B), illustrated in yellow and green, respectively.  
787 
 
 
788 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  41 / 55 
 
Figure 1-figure supplement 2| Experimentally measured PSF of the whole imaging 
789 
system 
790 
 
791 
Maximum intensity projections (MIPs) of the measured raw PSF stack. The stack was 
792 
2048 pixels × 2048 pixels × 200 pixels with a voxel size of 1.6 µm × 1.6 μm × 2 μm.  
793 
 
 
794 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  42 / 55 
 
Figure 1-figure supplement 3| PSF of Group A micro-lenses: PSF_A 
795 
 
796 
Maximum intensity projections (MIP) of PSF_A. PSF_A was extracted from 
797 
experimentally measured PSF (Figure 1-figure supplement 2) according to individual 
798 
micro-lens positions in group A. 
799 
 
 
800 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  43 / 55 
 
Figure 1-figure supplement 4| PSF of Group B micro-lenses: PSF_B 
801 
 
802 
Maximum intensity projections (MIP) of PSF_B. PSF_B was extracted from 
803 
experimentally measured PSFs (Figure 1-figure supplement 2) according to individual 
804 
micro-lens positions in group B. 
805 
 
 
806 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  44 / 55 
 
Figure 1-figure supplement 5| Example of camera captured raw imaging data of 
807 
larval zebrafish. 
808 
 
809 
Raw fluorescence imaging data consisted of 27 sub-images of a larval zebrafish formed 
810 
by 27 micro-lenses. Under the condition that the PSF is spatially invariant, which is 
811 
satisfied apart from small aberrations, the algorithm can handle overlapping fish images. 
812 
 
 
813 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  45 / 55 
 
Figure 1-figure supplement 6| Characterization of in-plane resolution of micro-
814 
lenses 
815 
 
816 
Fourier transforms of raw images of a 0.5-μm diameter fluorescent particle placed at 
817 
different locations (x = -400, 0, 400 μm; z = -100, 0, 100 μm) were plotted in log scales. 
818 
Dashed circles represent in-plane spatial frequency coordinates corresponding to spatial 
819 
resolutions of 3.2 μm and 4 μm, respectively. 
820 
 
 
821 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  46 / 55 
 
Figure 1-figure supplement 7| Characterization of axial resolution of XLFM 
822 
afforded by individual micro-lenses 
823 
 
824 
Characterization of axial resolution using a 0.5-μm diameter bright fluorescent particle. (a) 
825 
Maximum intensity projection of an image stack consisting of the particle’s fluorescent 
826 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  47 / 55 
 
images captured at different z positions. (b) Analysis of the images formed by micro-
827 
lenses 1 and 2, indicated by sub-regions in (a). The first and second columns are the 
828 
particle’s fluorescent images captured at different z positions separated by 5 μm. The 
829 
third column is the sum of columns 1 and 2. The fourth column is the Fourier analysis of 
830 
column 3 using function: f�x� � log 
�|��x�| ), where ��x�  represents the Fourier 
831 
transform. The fifth column is the deconvolution of column 3 using Wiener filtering 
832 
method. Experimentally measured images of the bead at different z positions (z = -100 
833 
μm, z = 0 μm and z = 100μm ) are employed as PSFs to deconvolve different images (C1, 
834 
C2 and C3), respectively.  
835 
 
 
836 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  48 / 55 
 
Figure 1-figure supplement 8| Characterization of magnification variation of micro-
837 
lenses in XLFM 
838 
 
839 
Magnifications of 27 micro-lenses were measured at different locations across the field of 
840 
view. A fluorescent bead originally placed at the center of the field of view (x, y, z=0) 
841 
was moved to six different locations (x = 200 μm, 300 μm, 400 μm, -200 μm, -300 μm, -
842 
400 μm, y = 0, z = 0). Six classes of the bead’s image shifts, represented by different 
843 
colors, were measured. Each class consisted of 27 image shifts formed by 27 micro-
844 
lenses. Within each class, image shifts were normalized to the one from the first micro-
845 
lens. The first 12 micro-lenses and the rest formed two different groups of micro-lenses: 
846 
group B and group A, consistent with Figure 1-figure supplements 3 & 4. The 
847 
magnification variation of a single micro-lens across the field of view was small (< 0.3%), 
848 
suggesting that the spatial invariance of individual micro-lens’ PSF was well preserved 
849 
across the field of view of Ø = 800 μm. The variation across different micro-lenses within 
850 
one group (A/B) was more evident (~ 2%), suggesting that the combined PSF from 
851 
different micro-lenses was not perfectly spatially invariant. 
 
852 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  49 / 55 
 
Figure 1-figure supplement 9| Resolution degradation due to focal length variation 
853 
of micro-lenses 
854 
 
855 
Maximum intensity projections (MIPs) of a reconstructed fluorescent bead positioned at 
856 
different locations across the field of view. As the bead moved to the edge of the field of 
857 
view, the reconstruction became distorted because the magnification variation of the 
858 
micro-lenses led to spatial variance of total PSF. Scale bars are 10 µm. 
859 
 
 
860 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  50 / 55 
 
Figure 1-figure supplement 10| Characterization of axial resolution of XLFM at low 
861 
SNR 
862 
 
863 
Characterization of axial resolution using densely packed fluorescent particles (0.5 μm in 
864 
diameter) at low SNR. (a) Synthetic XLFM raw image (Methods) formed by two layers 
865 
of fluorescent particles with different z positions. (b) Axial resolution at different depths 
866 
characterized by the minimum separation of two particles in z, which can be resolved 
867 
using the reconstruction algorithm (Methods). (c) Left, reconstructed examples of X-Z 
868 
projections of two particles located at different z positions (-70 μm, -30 μm, 30 μm, 70 
869 
μm) with different axial separations (6 μm, 5-μm, 5-μm, 6 μm); right, extracted intensity 
870 
profiles of these examples.  
871 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  51 / 55 
 
Figure 1-figure supplement 11| Dependence of imaging resolution on the sparseness 
872 
of the sample  
873 
 
874 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  52 / 55 
 
Characterization of the dependence of imaging resolution on the sparseness of the sample 
875 
using computer simulation. (a) Maximum intensity projections (MIPs) of a numerically 
876 
simulated (top) and reconstructed (bottom) larval zebrafish with randomly distributed 
877 
active neurons. Red and green lines indicate positions where simulated (red) and 
878 
reconstructed (green) cross-sections are compared. We assumed that the total number of 
879 
neurons in the zebrafish brain is 80,000, and gradually increased the sparseness index , 
880 
the fraction of neurons activated at a given frame. (b)–(d) Characterization of the 
881 
reconstruction results for different . Insets are magnified views of rectangular regions. 
882 
Red and green dots are simulated and reconstructed neurons, respectively. 
883 
 
 
884 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  53 / 55 
 
Figure 1-figure supplement 12| Characterization of photobleaching in fluorescence 
885 
imaging by XLFM 
886 
 
887 
Photobleaching was characterized by a total fluorescence intensity change of five 5 dpf 
888 
zebrafish larval with nucleus-localized GCamp6f (huc:h2b-gcamp6f). Each fish was 
889 
embedded in 1% agarose and continuously exposed to 2.5 mW/mm2 fluorescence 
890 
excitation laser (488 nm) illumination. After ~100 min, corresponding to 300,000 
891 
volumes with a volume rate of 50 volumes/s, total fluorescence intensity dropped to half 
892 
of that at the starting point. Random spikes corresponded to spontaneous neural activity. 
893 
Fish were alive and swam normally when they were relieved from the agarose after 
894 
imaging. 
895 
 
 
896 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  54 / 55 
 
Figure 2-figure supplement 1| Characterization of the autofocus system 
897 
 
898 
(a) Autofocus camera behind a one-dimensional lenslet array captured triplet images of 
899 
the fish head (up). Its autocorrelation function was computed (bottom). (b) Central line 
900 
profile of the autocorrelation function was extracted and inter-fish distance was computed 
901 
as local maximums in the autocorrelation function. (c) Axial shift of the fish head, 
902 
calibrated by moving the piezo at a constant interval, changed linearly (red line) with 
903 
inter-fish distance.   
904 
 
905 
 
906 
 
907 
 
908 
 
909 
 
910 
 
911 
 
912 
 
913 
 
914 
 
915 
 
916 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
  55 / 55 
 
Source Code File 1| Computer-Aided Design files of mounting plates for micro-
917 
lenses array 
918 
 
919 
Source Code File 2| Source code for XLFM reconstruction 
920 
 
921 
Source Code File 3| Source code for Real-Time behavioral analysis  
922 
 
923 
.
CC-BY-NC-ND 4.0 International license
It is made available under a 
(which was not peer-reviewed) is the author/funder, who has granted bioRxiv a license to display the preprint in perpetuity.
The copyright holder for this preprint
. 
http://dx.doi.org/10.1101/131532
doi: 
bioRxiv preprint first posted online Apr. 28, 2017; 
